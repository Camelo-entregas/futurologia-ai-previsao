<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FuturoLogia IA - Análise em Tempo Real</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4CAF50;
      --primary-light: #81C784;
      --primary-dark: #388E3C;
      --secondary: #8BC34A;
      --accent: #CDDC39;
      --dark: #2E7D32;
      --light: #E8F5E9;
      --white: #FFFFFF;
      --text: #1B5E20;
    }
    
    /* ... (mantenha todo o CSS anterior) ... */
    
    .live-badge {
      background-color: #f44336;
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin-left: 0.5rem;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    .match-status {
      font-size: 0.9rem;
      color: #666;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- ... (mantenha o header e estrutura anterior) ... -->

  <script>
    // Configurações da API
    const API_KEY = '62271872bf054aeb61b121932c95d3ee';
    const API_HOST = 'api-football-v1.p.rapidapi.com';
    
    // Dados em cache para evitar muitas chamadas à API
    let cache = {
      leagues: null,
      teams: {},
      matches: {}
    };

    document.addEventListener('DOMContentLoaded', function() {
      const leagueSelect = document.getElementById('league-select');
      const homeTeamSelect = document.getElementById('home-team');
      const awayTeamSelect = document.getElementById('away-team');
      const analyzeBtn = document.getElementById('analyze-btn');
      const loadingDiv = document.getElementById('loading');
      const analysisContainer = document.getElementById('analysis-container');
      
      // 1. Carregar campeonatos ao iniciar
      loadLeagues();
      
      async function loadLeagues() {
        try {
          const leagues = await fetchLeagues();
          populateLeagueSelect(leagues);
        } catch (error) {
          console.error("Erro ao carregar ligas:", error);
          leagueSelect.innerHTML = '<option value="">Erro ao carregar campeonatos</option>';
        }
      }
      
      async function fetchLeagues() {
        // Verifica cache primeiro
        if (cache.leagues) return cache.leagues;
        
        const response = await fetch(`https://${API_HOST}/v3/leagues`, {
          headers: {
            'X-RapidAPI-Key': API_KEY,
            'X-RapidAPI-Host': API_HOST
          }
        });
        
        const data = await response.json();
        cache.leagues = data.response.map(league => ({
          id: league.league.id,
          name: league.league.name,
          country: league.country.name,
          season: league.season
        }));
        
        return cache.leagues;
      }
      
      function populateLeagueSelect(leagues) {
        leagueSelect.innerHTML = '<option value="">Selecione um campeonato</option>';
        leagues.forEach(league => {
          leagueSelect.innerHTML += `
            <option value="${league.id}">
              ${league.name} (${league.country} ${league.season})
            </option>
          `;
        });
      }
      
      // 2. Quando selecionar um campeonato, carregar times
      leagueSelect.addEventListener('change', async function() {
        const leagueId = this.value;
        
        if (!leagueId) {
          resetTeamSelects();
          return;
        }
        
        try {
          const teams = await fetchTeams(leagueId);
          populateTeamSelects(teams);
        } catch (error) {
          console.error("Erro ao carregar times:", error);
          homeTeamSelect.innerHTML = '<option value="">Erro ao carregar times</option>';
          awayTeamSelect.innerHTML = '<option value="">Erro ao carregar times</option>';
        }
      });
      
      async function fetchTeams(leagueId) {
        // Verifica cache
        if (cache.teams[leagueId]) return cache.teams[leagueId];
        
        const currentYear = new Date().getFullYear();
        const response = await fetch(
          `https://${API_HOST}/v3/teams?league=${leagueId}&season=${currentYear}`, 
          {
            headers: {
              'X-RapidAPI-Key': API_KEY,
              'X-RapidAPI-Host': API_HOST
            }
          }
        );
        
        const data = await response.json();
        cache.teams[leagueId] = data.response.map(team => ({
          id: team.team.id,
          name: team.team.name,
          logo: team.team.logo
        }));
        
        return cache.teams[leagueId];
      }
      
      function populateTeamSelects(teams) {
        homeTeamSelect.innerHTML = '<option value="">Selecione o mandante</option>';
        awayTeamSelect.innerHTML = '<option value="">Selecione o visitante</option>';
        
        teams.forEach(team => {
          homeTeamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
          awayTeamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
        });
        
        homeTeamSelect.disabled = false;
        awayTeamSelect.disabled = false;
      }
      
      function resetTeamSelects() {
        homeTeamSelect.innerHTML = '<option value="">Selecione um campeonato</option>';
        awayTeamSelect.innerHTML = '<option value="">Selecione um campeonato</option>';
        homeTeamSelect.disabled = true;
        awayTeamSelect.disabled = true;
        analyzeBtn.disabled = true;
      }
      
      // 3. Quando ambos times forem selecionados, habilitar análise
      homeTeamSelect.addEventListener('change', checkTeamsSelected);
      awayTeamSelect.addEventListener('change', checkTeamsSelected);
      
      function checkTeamsSelected() {
        analyzeBtn.disabled = !(homeTeamSelect.value && awayTeamSelect.value);
      }
      
      // 4. Ao clicar em analisar, buscar dados dos últimos 5 jogos
      analyzeBtn.addEventListener('click', async function() {
        const leagueId = leagueSelect.value;
        const homeTeamId = homeTeamSelect.value;
        const awayTeamId = awayTeamSelect.value;
        
        if (!leagueId || !homeTeamId || !awayTeamId) return;
        
        try {
          // Mostrar loading
          loadingDiv.style.display = 'block';
          analysisContainer.style.display = 'none';
          
          // Buscar dados
          const [homeTeam, awayTeam, matches] = await Promise.all([
            getTeamDetails(homeTeamId),
            getTeamDetails(awayTeamId),
            fetchHeadToHead(homeTeamId, awayTeamId)
          ]);
          
          // Processar e exibir dados
          displayAnalysis(homeTeam, awayTeam, matches);
          
        } catch (error) {
          console.error("Erro na análise:", error);
          alert("Erro ao buscar dados. Tente novamente.");
        } finally {
          loadingDiv.style.display = 'none';
          analysisContainer.style.display = 'block';
        }
      });
      
      async function getTeamDetails(teamId) {
        // Busca em todos os times já carregados
        for (const leagueId in cache.teams) {
          const team = cache.teams[leagueId].find(t => t.id == teamId);
          if (team) return team;
        }
        
        // Se não encontrado no cache, busca na API
        const response = await fetch(
          `https://${API_HOST}/v3/teams?id=${teamId}`,
          {
            headers: {
              'X-RapidAPI-Key': API_KEY,
              'X-RapidAPI-Host': API_HOST
            }
          }
        );
        
        const data = await response.json();
        return {
          id: data.response[0].team.id,
          name: data.response[0].team.name,
          logo: data.response[0].team.logo
        };
      }
      
      async function fetchHeadToHead(homeTeamId, awayTeamId) {
        const cacheKey = `${homeTeamId}-${awayTeamId}`;
        
        // Verifica cache (válido por 1 hora)
        if (cache.matches[cacheKey] && 
            (Date.now() - cache.matches[cacheKey].timestamp) < 3600000) {
          return cache.matches[cacheKey].data;
        }
        
        const response = await fetch(
          `https://${API_HOST}/v3/fixtures/headtohead?h2h=${homeTeamId}-${awayTeamId}&last=5`,
          {
            headers: {
              'X-RapidAPI-Key': API_KEY,
              'X-RapidAPI-Host': API_HOST
            }
          }
        );
        
        const data = await response.json();
        
        // Armazena no cache
        cache.matches[cacheKey] = {
          timestamp: Date.now(),
          data: data.response
        };
        
        return data.response;
      }
      
      function displayAnalysis(homeTeam, awayTeam, matches) {
        // 1. Exibir informações dos times
        document.getElementById('home-name').textContent = homeTeam.name;
        document.getElementById('away-name').textContent = awayTeam.name;
        document.getElementById('home-team-name').textContent = homeTeam.name;
        document.getElementById('away-team-name').textContent = awayTeam.name;
        
        document.getElementById('home-logo').src = homeTeam.logo || '';
        document.getElementById('away-logo').src = awayTeam.logo || '';
        
        // 2. Calcular estatísticas
        const stats = calculateStats(matches, homeTeam.id);
        
        // 3. Atualizar a interface
        updateStatsUI(stats);
        generateRecommendations(stats);
      }
      
      function calculateStats(matches, homeTeamId) {
        let homeWins = 0, awayWins = 0, draws = 0;
        let homeGoals = 0, awayGoals = 0;
        let over25 = 0, bothScored = 0;
        let yellowCards = 0, redCards = 0;
        let corners = 0;
        
        matches.forEach(match => {
          const isHome = match.teams.home.id == homeTeamId;
          const homeGoalsMatch = isHome ? match.goals.home : match.goals.away;
          const awayGoalsMatch = isHome ? match.goals.away : match.goals.home;
          
          // Resultado
          if (match.goals.home === match.goals.away) draws++;
          else if ((match.goals.home > match.goals.away && isHome) || 
                  (match.goals.away > match.goals.home && !isHome)) {
            homeWins++;
          } else {
            awayWins++;
          }
          
          // Gols
          homeGoals += homeGoalsMatch;
          awayGoals += awayGoalsMatch;
          
          // Over 2.5 e Both to Score
          if (match.goals.home + match.goals.away > 2.5) over25++;
          if (match.goals.home > 0 && match.goals.away > 0) bothScored++;
          
          // Estatísticas adicionais (se disponíveis)
          if (match.statistics) {
            const stats = match.statistics;
            
            const getStat = (type, team) => {
              const stat = stats.find(s => s.type === type);
              return stat ? stat[team] : 0;
            };
            
            yellowCards += getStat('Yellow Cards', 'home') + getStat('Yellow Cards', 'away');
            redCards += getStat('Red Cards', 'home') + getStat('Red Cards', 'away');
            corners += getStat('Corner Kicks', 'home') + getStat('Corner Kicks', 'away');
          }
        });
        
        const totalMatches = matches.length;
        
        return {
          totalMatches,
          homeWins,
          awayWins,
          draws,
          homeGoals,
          awayGoals,
          over25: Math.round((over25 / totalMatches) * 100),
          bothScored: Math.round((bothScored / totalMatches) * 100),
          yellowCards,
          redCards,
          corners,
          homeWinProb: Math.round((homeWins / totalMatches) * 100),
          awayWinProb: Math.round((awayWins / totalMatches) * 100),
          drawProb: Math.round((draws / totalMatches) * 100),
          avgHomeGoals: (homeGoals / totalMatches).toFixed(1),
          avgAwayGoals: (awayGoals / totalMatches).toFixed(1)
        };
      }
      
      function updateStatsUI(stats) {
        // Probabilidades
        document.getElementById('home-win-prob').textContent = `${stats.homeWinProb}%`;
        document.getElementById('draw-prob').textContent = `${stats.drawProb}%`;
        document.getElementById('away-win-prob').textContent = `${stats.awayWinProb}%`;
        
        document.getElementById('home-progress').style.width = `${stats.homeWinProb}%`;
        document.getElementById('draw-progress').style.width = `${stats.drawProb}%`;
        document.getElementById('away-progress').style.width = `${stats.awayWinProb}%`;
        
        // Estatísticas
        document.getElementById('home-wins').textContent = stats.homeWins;
        document.getElementById('away-wins').textContent = stats.awayWins;
        document.getElementById('draws').textContent = stats.draws;
        document.getElementById('home-goals').textContent = stats.homeGoals;
        document.getElementById('away-goals').textContent = stats.awayGoals;
        document.getElementById('over-25').textContent = `${stats.over25}%`;
        document.getElementById('both-score').textContent = `${stats.bothScored}%`;
        document.getElementById('yellow-cards').textContent = stats.yellowCards;
      }
      
      function generateRecommendations(stats) {
        // Recomendação BTTS
        let bttsText = `Nos últimos ${stats.totalMatches} confrontos, ambos os times marcaram em `;
        bttsText += `${Math.round(stats.bothScored/100 * stats.totalMatches)} oportunidades. `;
        bttsText += `Média de ${stats.avgHomeGoals} gols do mandante e ${stats.avgAwayGoals} gols do visitante.`;
        
        // Recomendação Over/Under
        let overText = `${stats.over25}% dos últimos confrontos tiveram 3+ gols. `;
        overText += `Média total de ${(stats.homeGoals + stats.awayGoals)/stats.totalMatches} gols por jogo.`;
        
        // Recomendação 1º Tempo
        let halftimeText = `O mandante venceu o 1º tempo em ${Math.round(stats.homeWinProb * 0.6)}% `;
        halftimeText += `dos últimos confrontos. Média de ${(stats.avgHomeGoals * 0.6).toFixed(1)} gols no primeiro tempo.`;
        
        document.getElementById('btts-analysis').textContent = bttsText;
        document.getElementById('over-analysis').textContent = overText;
        document.getElementById('half-time-analysis').textContent = halftimeText;
      }
      
      // 5. Verificar se há jogo ao vivo entre os times selecionados
      async function checkLiveMatch(homeTeamId, awayTeamId) {
        try {
          const response = await fetch(
            `https://${API_HOST}/v3/fixtures?teams=${homeTeamId}-${awayTeamId}&live=all`,
            {
              headers: {
                'X-RapidAPI-Key': API_KEY,
                'X-RapidAPI-Host': API_HOST
              }
            }
          );
          
          const data = await response.json();
          if (data.response && data.response.length > 0) {
            return data.response[0]; // Retorna o jogo ao vivo
          }
          return null;
        } catch (error) {
          console.error("Erro ao verificar jogo ao vivo:", error);
          return null;
        }
      }
    });
  </script>
</body>
</html>